apiVersion: batch/v1
kind: Job
metadata:
  name: zach
spec:
  ttlSecondsAfterFinished: 86400
  template:
    spec:
      initContainers:
      - name: check-db
        image: postgres:17
        command:
          - "sh"
          - "-c"
          - |
            export PGPASSWORD="$DB_PASSWORD"
            echo "Проверяем подключение к $DB_HOST:$DB_PORT..."
            
            # Проверка доступности PostgreSQL
            until pg_isready -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" -t 2; do
              echo "[$(date)] Ожидание PostgreSQL..."
              sleep 2
            done

            # Проверка существования таблицы zach
            until PGPASSWORD="$DB_PASSWORD" psql \
              -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" \
              -c "SELECT 1 FROM information_schema.tables WHERE table_name = 'zach'" | grep -q 1; do
              echo "[$(date)] Таблица zach не найдена"
              sleep 2
            done

            echo "[$(date)] Проверка завершена"
        envFrom:
        - secretRef:
            name: jobs-secrets

      containers:
      - name: zach
        image: dimavysotskiy/parser-zach:1.0
        envFrom:
        - secretRef:
            name: jobs-secrets
      restartPolicy: Never